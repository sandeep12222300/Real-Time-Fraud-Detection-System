name: CI - Build & Validate

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # Java - Fraud Processor
      # -------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build Fraud Processor
        working-directory: fraud-processor
        run: mvn clean package -DskipTests

      - name: Build Transaction Producer
        working-directory: transaction-producer
        run: mvn clean package -DskipTests

      # -------------------------
      # Python - ML Service
      # -------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ML dependencies
        working-directory: fraud-ml-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -------------------------
      # Docker Compose Validation
      # -------------------------
      - name: Validate Docker Compose file
        run: docker compose config

      # -------------------------
      # Docker Image Builds (CI)
      # -------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Fraud Processor image
        run: docker build -t fraud-processor:ci ./fraud-processor

      - name: Build Transaction Producer image
        run: docker build -t transaction-producer:ci ./transaction-producer

      - name: Build ML Service image
        run: docker build -t fraud-ml-service:ci ./fraud-ml-service

      - name: Build Fraud Dashboard image
        run: docker build -t fraud-dashboard:ci ./fraud-dashboard

      # -------------------------
      # Docker Hub Login
      # -------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------
      # Build & Push Images
      # -------------------------
      - name: Build & Push Fraud Processor
        run: |
          docker build -t sandeep12222300/fraud-processor:latest ./fraud-processor
          docker push sandeep12222300/fraud-processor:latest

      - name: Build & Push Transaction Producer
        run: |
          docker build -t sandeep12222300/transaction-producer:latest ./transaction-producer
          docker push sandeep12222300/transaction-producer:latest

      - name: Build & Push ML Service
        run: |
          docker build -t sandeep12222300/fraud-ml-service:latest ./fraud-ml-service
          docker push sandeep12222300/fraud-ml-service:latest

      - name: Build & Push Fraud Dashboard
        run: |
          docker build -t sandeep12222300/fraud-dashboard:latest ./fraud-dashboard
          docker push sandeep12222300/fraud-dashboard:latest
